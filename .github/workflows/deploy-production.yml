name: Deploy to Production

on:
  push:
    branches: [main]
    tags:
      - 'v*.*.*'
  workflow_dispatch:

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  pre-deployment-checks:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Run linter
        run: npm run lint

      - name: Run type check
        run: npx tsc --noEmit

      - name: Run tests
        env:
          DATABASE_URL: "file:./test.db"
          NEXTAUTH_SECRET: "test-secret-for-deployment"
          NEXTAUTH_URL: "http://localhost:3000"
          SPOTIFY_CLIENT_ID: "test-client-id"
          SPOTIFY_CLIENT_SECRET: "test-client-secret"
          NODE_ENV: "test"
        run: |
          npx prisma migrate deploy
          npm run test:unit

      - name: Build application
        env:
          DATABASE_URL: "file:./test.db"
          NEXTAUTH_SECRET: "test-secret-for-build"
          NEXTAUTH_URL: "http://localhost:3000"
          SPOTIFY_CLIENT_ID: "test-client-id"
          SPOTIFY_CLIENT_SECRET: "test-client-secret"
        run: npm run build

      - name: Check build artifacts
        run: |
          if [ ! -d ".next" ]; then
            echo "‚ùå ERROR: .next directory not found"
            exit 1
          fi
          echo "‚úÖ Build artifacts verified"

  deploy:
    name: Deploy to Vercel Production
    needs: pre-deployment-checks
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project Artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy Project Artifacts to Vercel
        id: deploy
        run: |
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $DEPLOYMENT_URL"

      - name: Wait for deployment to be ready
        run: sleep 30

  post-deployment-checks:
    name: Post-Deployment Health Checks
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Wait for deployment stabilization
        run: sleep 15

      - name: Check health endpoint
        id: health_check
        run: |
          HEALTH_URL="${{ secrets.PRODUCTION_URL }}/api/health"
          echo "Checking health endpoint: $HEALTH_URL"

          MAX_RETRIES=5
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Health check passed (HTTP $HTTP_CODE)"
              exit 0
            else
              echo "‚ö†Ô∏è  Health check returned HTTP $HTTP_CODE (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
              RETRY_COUNT=$((RETRY_COUNT + 1))

              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Waiting 10 seconds before retry..."
                sleep 10
              fi
            fi
          done

          echo "‚ùå Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Verify database connectivity
        run: |
          echo "Database connectivity is verified through health endpoint"

      - name: Check for Sentry errors
        if: always()
        run: |
          echo "‚ö†Ô∏è  Manual action required: Check Sentry dashboard for new errors"
          echo "Visit: https://sentry.io"

  smoke-tests:
    name: Production Smoke Tests
    needs: post-deployment-checks
    runs-on: ubuntu-latest
    steps:
      - name: Test homepage availability
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.PRODUCTION_URL }}" || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Homepage is accessible"
          else
            echo "‚ùå Homepage returned HTTP $HTTP_CODE"
            exit 1
          fi

      - name: Test API stats endpoint (unauthenticated)
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.PRODUCTION_URL }}/api/stats" || echo "000")
          if [ "$HTTP_CODE" = "401" ]; then
            echo "‚úÖ Stats API correctly returns 401 for unauthenticated requests"
          else
            echo "‚ùå Stats API returned unexpected HTTP $HTTP_CODE (expected 401)"
            exit 1
          fi

      - name: Test API export endpoint (unauthenticated)
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.PRODUCTION_URL }}/api/export" || echo "000")
          if [ "$HTTP_CODE" = "401" ]; then
            echo "‚úÖ Export API correctly returns 401 for unauthenticated requests"
          else
            echo "‚ùå Export API returned unexpected HTTP $HTTP_CODE (expected 401)"
            exit 1
          fi

  notify-deployment:
    name: Notify Deployment Status
    needs: [deploy, post-deployment-checks, smoke-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment successful notification
        if: needs.smoke-tests.result == 'success'
        run: |
          echo "‚úÖ üöÄ Deployment successful!"
          echo "URL: ${{ secrets.PRODUCTION_URL }}"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

      - name: Deployment failed notification
        if: needs.smoke-tests.result != 'success'
        run: |
          echo "‚ùå Deployment failed or smoke tests did not pass"
          echo "Please check the workflow logs and consider rollback"
          exit 1

  rollback-on-failure:
    name: Rollback on Failure
    needs: [deploy, post-deployment-checks, smoke-tests]
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Rollback to previous deployment
        run: |
          echo "‚ö†Ô∏è  ROLLBACK REQUIRED"
          echo "Health checks or smoke tests failed"
          echo "Manual rollback instructions:"
          echo "1. Visit Vercel dashboard: https://vercel.com/dashboard"
          echo "2. Find the previous successful deployment"
          echo "3. Click 'Promote to Production'"
          echo ""
          echo "Or use CLI:"
          echo "vercel rollback --token=\$VERCEL_TOKEN"

      - name: Create incident issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Production Deployment Failed - Rollback Required',
              body: `## Deployment Failure Alert

              **Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              **Timestamp:** ${new Date().toISOString()}
              **Branch:** ${context.ref}

              ### Action Required
              1. Review the failed deployment logs
              2. Perform rollback using Vercel dashboard
              3. Investigate root cause
              4. Fix issues before next deployment

              ### Rollback Instructions
              \`\`\`bash
              vercel rollback --token=$VERCEL_TOKEN
              \`\`\`

              cc: @${context.actor}`,
              labels: ['incident', 'production', 'deployment-failed']
            })

name: Security Scanning

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Mondays at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit (production dependencies)
        run: |
          npm audit --production --audit-level=moderate || true
          echo "Checking for high and critical vulnerabilities..."
          npm audit --production --audit-level=high

      - name: Check for outdated dependencies
        run: |
          echo "Checking for outdated dependencies..."
          npm outdated || true

  secret-scanning:
    name: Secret Scanning with TruffleHog
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for scanning

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  code-scanning:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript,typescript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  security-headers-check:
    name: Security Headers Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check security headers configuration
        run: |
          echo "Checking next.config.mjs for security headers..."
          if grep -q "X-Frame-Options\|Content-Security-Policy\|X-Content-Type-Options" next.config.mjs || \
             grep -q "X-Frame-Options\|Content-Security-Policy\|X-Content-Type-Options" next.config.ts; then
            echo "✅ Security headers found in configuration"
          else
            echo "⚠️ WARNING: Security headers not found in next.config"
            echo "Consider adding security headers (X-Frame-Options, CSP, etc.)"
          fi

  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for license file
        run: |
          if [ -f "LICENSE" ] || [ -f "LICENSE.md" ] || [ -f "LICENSE.txt" ]; then
            echo "✅ License file found"
          else
            echo "⚠️ WARNING: No LICENSE file found"
            echo "Consider adding a LICENSE file to your repository"
          fi

      - name: Install license checker
        run: npm install -g license-checker

      - name: Check dependency licenses
        run: |
          echo "Checking licenses of dependencies..."
          license-checker --summary || true

  env-vars-check:
    name: Environment Variables Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for .env.example
        run: |
          if [ -f ".env.example" ] || [ -f ".env.template" ]; then
            echo "✅ Environment template found"
          else
            echo "⚠️ WARNING: No .env.example file found"
            echo "Consider adding an .env.example file"
          fi

      - name: Check for committed secrets (basic check)
        run: |
          echo "Checking for potential secrets in code..."
          if grep -r "SPOTIFY_CLIENT_SECRET\s*=\s*['\"].*['\"]" --include="*.ts" --include="*.js" .; then
            echo "❌ ERROR: Potential hardcoded secrets found"
            exit 1
          else
            echo "✅ No obvious hardcoded secrets found"
          fi

  all-security-checks-passed:
    name: All Security Checks Passed
    runs-on: ubuntu-latest
    needs: [dependency-audit, secret-scanning, security-headers-check, license-check, env-vars-check]
    if: always()
    steps:
      - name: Check if all security checks passed
        run: |
          if [ "${{ needs.dependency-audit.result }}" != "success" ] || \
             [ "${{ needs.secret-scanning.result }}" != "success" ] || \
             [ "${{ needs.security-headers-check.result }}" != "success" ] || \
             [ "${{ needs.license-check.result }}" != "success" ] || \
             [ "${{ needs.env-vars-check.result }}" != "success" ]; then
            echo "⚠️ One or more security checks failed or had warnings"
            echo "Please review the security scan results above"
            # Don't fail the workflow, just warn
            exit 0
          fi
          echo "✅ All security checks passed successfully!"
